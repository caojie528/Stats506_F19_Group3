---
title: "STATS 506 Project"
author: "Group 3"
date: "12/11/2019"
output: html_document
---

```{r setup, include=FALSE}
# set up
library(foreign)
library(tidyr)
library(plyr)
library(dplyr)
library(corrplot)
library(lme4)
library(ggplot2)
library(ggeffects)
```
#### Question: Do people diagnosed with diabetes consume less calories in the US?
  
```{r, warning=FALSE}
# prepare datasets
DEMO = read.xport("../Data/DEMO_I.XPT")
DIQ = read.xport("../Data/DIQ_I.XPT")
PAQ = read.xport("../Data/PAQ_I.XPT")
DR1 = read.xport("../Data/DR1TOT_I.XPT")
DR2 = read.xport("../Data/DR2TOT_I.XPT")
BMX = read.xport("../Data/BMX_I.XPT")
```

Variables of interest:

| Dataset | Variable Name | Variable Description            | Notes on variable use            |
|:------- |:------------- |:------------------------------- |:-------------------------------- |
| (ALL)   | SEQN          | Respondent sequence number      | For merging purpose              |
| DEMO    | RIDAGEYR      | Age in years at screening       | Top-coded at 80 and above,       |
|         |               |                                 | convert to age groups            |
|         | RIAGENDR      | Gender                          |                                  |
|         | RIDEXPRG      | Pregnancy status at exam        | Exclude pregnant participants    |
| DIQ     | DIQ010        | Doctor told you have diabetes   | Binary                           |
| PAQ     | PAD615        | Vigorous-intensity work (min)   |                                  |
|         | PAD630        | Moderate-intensity work (min)   |                                  |
|         | PAD680        | Sedentary activity (min)        |                                  |
| DR1     | DR1TKCAL      | Energy (kcal)                   | Response variable                |
| DR2     | DR2TKCAL      | Energy (kcal)                   | Response variable                |
| BMX     | BMXBMI        | Body Mass Index (kg/m**2)       |                                  |

```{r, warning=FALSE}
# Merge all of the relevant variables
dm = join_all(list(DEMO[,c("SEQN", "RIDAGEYR", "RIAGENDR", "RIDEXPRG")],
                   DIQ[,c("SEQN", "DIQ010")],
                   PAQ[,c("SEQN", "PAD615", "PAD630", "PAD680")],
                   DR1[,c("SEQN", "DR1TKCAL")],
                   DR2[,c("SEQN", "DR2TKCAL")],
                   BMX[,c("SEQN", "BMXBMI")]),
              by = "SEQN")
names(dm) = c("SEQN","age","gender","pregnancy","DIQ010",
              "vig_work","mod_work","sed_act","DR1","DR2","bmi")
```

```{r, warning=FALSE}
# create a "not in" operator
`%notin%` = Negate(`%in%`)

# exclude data without diabetes diagnosis
c = c(1,2,3)
dm = dm[-which(dm$DIQ010 %notin% c), ]

# exclude pregnant participants
dm = dm[-which(dm$pregnancy==1), ]

# create a new variable representing diabetes
# 1 - diabetes or borderline
# 0 - non-diabetes
dm$diabetes = ifelse(dm$DIQ010==2, 0, 1)

# create a new variable representing male
# 1 - male
# 0 - female
dm$male = ifelse(dm$gender==1, 1, 0)

# pivot the data into "long" format
# and create a variable representing dietary interview day (1/2)
dm = dm %>%
  pivot_longer(
    cols = starts_with("DR"),
    names_to = "day",
    names_prefix = "DR",
    values_to = "kcal",
    values_drop_na = FALSE
  ) %>%
  arrange(SEQN, day)

# check for missing values for each variable
sort(colSums(is.na(dm)), decreasing = TRUE)
# percentage of missing values
sort(round(colSums(is.na(dm))/dim(dm)[1]*100, digits = 2), decreasing = TRUE)
```

```
vig_work: 86% missing
mod_work: 73% missing
```

`vig_work` and `mod_work` have much more missing values than other variables, so it is
reasonable to remove them from the data frame.  
`pregnancy` can also be removed since we only need this variable to filter out pregnant
individuals.  
`DIQ010` and `gender` are now redundant due to the new variables.  

Note that `age` is top-coded at 80, which means participants aged 80 or older were all
recorded as age 80. To avoid inaccurate data, we decided to set an age bound from 12 to 79.


```{r, warning=FALSE}
dm = dm %>%
  select(-pregnancy, -vig_work, -mod_work, -DIQ010, -gender) %>%
  filter(age>=12 & age<=79)
dm$day = as.numeric(dm$day)
# remove rows with missing value
dm_final = dm[complete.cases(dm),]
dr1_final = dm_final[dm_final$day==1,]
dr2_final = dm_final[dm_final$day==2,]
```

```{r, warning=FALSE}
# check if the response variable - kcal is normally distributed
# day1
# hist(dm_final[dm_final$day==1, ]$kcal, main = "Day 1")
ggplot(dr1_final, aes(x = kcal)) + 
  geom_histogram(aes(y = ..density..), 
                 bins = 100, 
                 fill = "blue", 
                 alpha = 0.8) + 
  stat_function(fun = dnorm, 
                args = list(mean = mean(dr1_final$kcal), 
                            sd = sd(dr1_final$kcal))) + 
  labs(x = "Total Energy (kcal)", y = "Frequency") + 
  theme_bw()

# day2
# hist(dm_final[dm_final$day==2, ]$kcal, breaks = 100, main = "Day 2")
ggplot(dr2_final, aes(x = kcal)) + 
  geom_histogram(aes(y = ..density..), 
                 bins = 100, 
                 fill = "blue", 
                 alpha = 0.8) + 
  stat_function(fun = dnorm, 
                args = list(mean = mean(dr2_final$kcal), 
                            sd = sd(dr2_final$kcal))) + 
  labs(x = "Total Energy (kcal)", y = "Frequency") + 
  theme_bw()
```


`kcal` seems to be approximately normal with a longer right tail for both day1 and day2.
In this case, no transformation would be needed.


```{r, warning=FALSE}
# fit a linear regression model for day 1
model = dr1_final %>% lm(formula = kcal ~ age + sed_act + bmi + factor(diabetes) + factor(male))
# check collinearity
summary(model)
faraway::vif(model)
cor1 = cor(dr1_final[, c("age", "sed_act", "bmi", "diabetes", "male")])
cor1
corrplot(cor1)
```


No collinearity found.


```{r, warning=FALSE}
# for the benefit of model fitting, convert `diabetes` and `male` into factor variables
dm_final$diabetes = factor(dm_final$diabetes)
dm_final$male = factor(dm_final$male)

# fit a linear mixed model
model2 = dm_final %>% lmer(formula = kcal ~ age + sed_act + bmi + 
                             diabetes + male + (1|SEQN))
summary(model2)

# Predicted total energy intake at population mean
me = ggpredict(model2, c("diabetes","male"))
plot(me, dodge = 0)
```